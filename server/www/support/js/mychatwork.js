var ToUserUIN="";var SoundNewMSG={};var SoundTypeMSG={};var SoundPressEnter={};var SoundPressBS={};var LMSG=[];if(!isIE6()){soundManager.url="js/";};$(document).ready(function(){LMSG=$.MCLocalize({LocalizeFile:"ru.json",UserDefinedLocalizeZone:"img, a"});function SoundCreate(){if(isIE6()){SoundNewMSG.play=function(){};SoundPressBS.play=function(){};SoundPressEnter.play=function(){};SoundTypeMSG.play=function(){};}else{soundManager.onready(function(){SoundNewMSG=soundManager.createSound({id:'newMSG',url:'sound/msg.mp3',volume:50});SoundPressBS=soundManager.createSound({id:'pressBS',url:'sound/chatbs.mp3',volume:50});SoundPressEnter=soundManager.createSound({id:'pressENT',url:'sound/chatret.mp3',volume:50});SoundTypeMSG=soundManager.createSound({id:'typeMSG',url:'sound/chattype.mp3',volume:50});});};};SoundCreate();function SoundOff(){setTimeout(SoundNewMSG.mute,100);setTimeout(SoundPressBS.mute,100);setTimeout(SoundPressEnter.mute,100);setTimeout(SoundTypeMSG.mute,100);};function SoundOn(){setTimeout(SoundNewMSG.unmute,100);setTimeout(SoundPressBS.unmute,100);setTimeout(SoundPressEnter.unmute,100);setTimeout(SoundTypeMSG.unmute,100);};var SoundIsMute=false;var MCConnect=new TMCRequest();var MCUserInfo=new TMCUserList();var MCGETReq=new O_GET_RequestParameters();var MCSelfInfo=new OWEBUserInfo();MCConnect.NoErrMsg=true;var miniWEBWindow=$("#miniWEBWindow");var TextMemo=$("#TextMemo");var SendBTN=$("#SendBTN");var DisplayText=$("#DisplayText");var ScrollDisplayText=$("#ScrollDisplayText");var StartChatTime=$("#StartChatTime");var ChatTime=$("#ChatTime");var CloseBTN=$("#CloseBTN");var PrintBTN=$("#PrintBTN");var OperatorFoto=$("#OperatorFoto");var OperatorName=$("#OperatorName");var SendToEmailBTN=$("#SendToEmailBTN");var OperatorValueBTN=$("#OperatorValueBTN");var OperatorReview=$("#OperatorReview");var OpReviewText=$("#OpReviewText");var SaveOpReview=$("#SaveOpReview");var SoundOnOffBTN=$("#SoundOnOffBTN");var OpRev=$(".OpRev");var RegUserInfoMedium=$("#RegUserInfoMedium");var OperatorTyping=$("#OperatorTyping");var TypingImg=$("#TypingImg");var TypingTimer=0;var RegUserInfoSmall=$("#RegUserInfoSmall");RegUserInfoSmall.Name=$(".user_name",RegUserInfoSmall);RegUserInfoSmall.EMail=$(".user_email",RegUserInfoSmall);RegUserInfoSmall.BTNBegin=$(".begin_speak",RegUserInfoSmall);var isOnline=$("#isOnline");var InfoWindow=$("#InfoWindow");var PingTimer=3000;var sendText="";var StartTime=new Date();var Now=0;var SelfUIN=null;var SelfPWD=null;var SelfName=LMSG["44"];var CookiePresent=false;var ConnectFailed=0;var TalkTimer=0;var MCSessionID=0;var MCAdditional="";var HW=$("#HW");var LoginForm=$("#LoginForm");var LoginUIN=$("#LoginUIN");var LoginPWD=$("#LoginPWD");var LoginBTN=$("#LoginBTN");var LoginIMG=$("#LoginIMG");var Period=$("#Period");var Loading=$("#Loading");var LoginInProgress=false;RegUserInfoSmall.TO_WINDOW_CENTER(HW);function LockUserWindow(){HW.addClass("not_logged");};function UnlockUserWindow(){HW.removeClass("not_logged");};$("#LoginUIN, #LoginPWD").keyboard('enter',{strict:true,event:'keydown'},function(){if(LoginInProgress==false){TryToLogin(LoginUIN.val(),LoginPWD.val())}});function ShowLoginForm(){LoginForm.removeClass("hideelement");LoginForm.TO_WINDOW_CENTER(HW);LoginUIN.focus();};LoginBTN.click(function(){if(LoginInProgress==false){TryToLogin(LoginUIN.val(),LoginPWD.val())};});function BooleanStateToString(State){if(State==true){return LMSG["5"];}else{return LMSG["4"];};};function BeginLogin(){var sGET=location.search;var hasRequests=(sGET.length>0)?MCGETReq.SetRecivedGETRequest(sGET):false;LockUserWindow();if(ConnectFailed==0){SelfUIN=$.cookie("UIN");SelfPWD=$.cookie("PWD");};if((SelfUIN==null)||(SelfPWD==null)){CookiePresent=false;}else{CookiePresent=true;};if(hasRequests==true){if(CookiePresent==false){if(MCGETReq.HasParametr(GET_regnewuser)==true){if(MCGETReq.HasParametr(GET_withuser)==true){ToUserUIN=MCGETReq.GetParametr(GET_withuser);MCConnect.SendDataToServer(CMD_COMMAND_REGISTER_USER);}else{alert(LMSG["45"]);};}else{if(MCGETReq.HasParametr(GET_withuser)){ToUserUIN=MCGETReq.GetParametr(GET_withuser);ShowLoginForm();};};}else{if(MCGETReq.HasParametr(GET_withuser)==true){ToUserUIN=MCGETReq.GetParametr(GET_withuser);TryToLogin(SelfUIN,SelfPWD);}else{alert(LMSG["45"]);};};}else{if(CookiePresent==false){ShowLoginForm();}else{TryToLogin(SelfUIN,SelfPWD);};};};function TryToLogin(_login,_pwd){LoginInProgress=true;LoginUIN.prop("disabled","true");LoginPWD.prop("disabled","true");LoginBTN.toggleClass("disabled");LoginIMG.toggleClass("hideelement");SelfUIN=_login;SelfPWD=_pwd;MCConnect.SendDataToServer(CMD_COMMAND_LOGIN+CR+_login+CR+_pwd+CR+CMD_COMMAND_MINI_CLIENT+CR+ToUserUIN);};function SayHello(){function TryHello(){var cookieName=$.cookie("NAME");var cookieMail=$.cookie("EMAIL");var UName=(cookieName!=null)?cookieName:trim(RegUserInfoSmall.Name.val());var UEmail=(cookieMail!=null)?cookieMail:trim(RegUserInfoSmall.EMail.val());if((UName.length>0)&&(isValidEmailAddress(UEmail))){MCSelfInfo.FillSmallInfo(UName,UEmail,GetUserOS(),GetUserLanguage(),GetUserRefLink(),GetUserBrouser());SelfName=UName;RegUserInfoSmall.addClass("hideelement");$.cookie("NAME",UName);$.cookie("EMAIL",UEmail);MCConnect.SendDataToServer(CMD_COMMAND_SETSMALLUSERINFO+CR+MCSessionID+CR+MCSelfInfo.GenerateMCUserInfo());AfterLogin();}else{alert(LMSG["46"]);};};RegUserInfoSmall.removeClass("hideelement");RegUserInfoSmall.Name.keyboard('enter',{strict:false,event:'keyup'},function(){TryHello();});RegUserInfoSmall.EMail.keyboard('enter',{strict:false,event:'keyup'},function(){TryHello();});RegUserInfoSmall.Name.focus();RegUserInfoSmall.BTNBegin.click(function(){TryHello();});};BeginLogin();var idServerRequests;function CloseOpReview(){if(OperatorReview.css("top")!="10px"){OperatorReview.animate({"top":"10px"},700);};TextMemo.focus();};function OpenOpReview(){if(OperatorReview.css("top")!="92px"){OperatorReview.animate({"top":"92px"},700);}OpReviewText.focus();};function SelectOpStars(){OpRev.each(function(){var _this=$(this);$("div",_this).each(function(idx){if(OpRev.selectedStar==undefined){$(this).removeClass("GoldStar");}else{if(idx<=OpRev.selectedStar){$(this).addClass("GoldStar");}else{$(this).removeClass("GoldStar");};};});});};function AfterLogin(){SoundOnOffBTN.click(function(){SoundPressEnter.stop();SoundTypeMSG.stop();if(SoundIsMute){$("#_soundOff",this).removeClass("hideelement");$("#_soundOn",this).addClass("hideelement");SoundOn();SoundIsMute=false;}else{$("#_soundOn",this).removeClass("hideelement");$("#_soundOff",this).addClass("hideelement");SoundOff();SoundIsMute=true;};});OpRev.mousemove(function(e){var _this=$(this);if((!_this.currentStar)||(_this.currentStar!=$(e.target).attr("st"))){_this.currentStar=$(e.target).attr("st");$("div",_this).each(function(idx){if(idx<=_this.currentStar){$(this).addClass("GoldStar");}else{$(this).removeClass("GoldStar");};});};}).mouseout(function(){SelectOpStars();}).click(function(e){OpRev.selectedStar=parseInt($(e.target).attr("st"));SelectOpStars();OpenOpReview();});ScrollDisplayText.click(function(){if(OperatorReview.css("top")=="92px"){CloseOpReview();};});$.keyboard('esc',{strict:false,event:'keydown'},function(){if(OperatorReview.css("top")=="92px"){CloseOpReview();};});SaveOpReview.click(function(){CloseOpReview();});MCUserInfo.GetUserNameByUin(SelfUIN);if(CookiePresent==false){var expr=parseInt($(":selected",Period).attr("period"));$.cookie("UIN",SelfUIN,{expires:expr});$.cookie("PWD",SelfPWD,{expires:expr});};StartChatTime.text(StartTime.myFormat("hh:nn:ss"));TalkTimer=setInterval(function(){Now++;var ss=Now%60;var hh=parseInt(Now/3600);var nn=parseInt(Now/60)-(hh*60);ChatTime.text(((hh<10)?("0"+hh):hh)+":"+((nn<10)?("0"+nn):nn)+":"+((ss<10)?("0"+ss):ss));},1000);MCConnect.SendDataToServer(CMD_COMMAND_PING+CR+MCSessionID+CR+ToUserUIN);idServerRequests=setInterval(function(){MCConnect.SendDataToServer(CMD_COMMAND_PING+CR+MCSessionID+CR+ToUserUIN);},PingTimer);TextMemo.removeAttr("readonly").keyboard('enter',{strict:false,event:'keyup'},function(){SoundTypeMSG.stop();SoundPressEnter.stop();SoundPressEnter.play();sendText=trim(TextMemo.val().replace("\n"," "));if(sendText!=""){MCConnect.SendDataToServer(CMD_COMMAND_SENDMSG+CR+MCSessionID+CR+ToUserUIN+CR+sendText);};TextMemo.val("");}).OnChangeEx(function(){SoundTypeMSG.play();}).focus().click(function(){if(OperatorReview.css("top")=="92px"){CloseOpReview();};});MCUserInfo.GetUserFotoByUin(ToUserUIN,MCSessionID);setTimeout(function(){OperatorFoto.removeClass("hideelement").attr("src","../"+MCUserInfo.GetUserFotoByUin(ToUserUIN)).css({height:"70px",width:"70px"});OperatorName.text(MCUserInfo.GetUserNameByUin(ToUserUIN));},0);UnlockUserWindow();};PrintBTN.click(function(){$.cookie("UIN",null);$.cookie("PWD",null);$.cookie("NAME",null);$.cookie("EMAIL",null);});OperatorValueBTN.click(function(){if(OperatorReview.css("top")=="10px"){OpenOpReview();}else{CloseOpReview();};});MCConnect.RequestSuccess=function(msg){function GetMsg(_msg){var msg_arr=[];if(trim(_msg).length>0){msg_arr=_msg.split(/[\r]/);var i=0;var uin="";var nik="";var _txt="";var typing=false;while(i<(msg_arr.length-1)){switch(msg_arr[i]){case"1":uin=msg_arr[i+1];_txt=ReplaseURLs(msg_arr[i+2]);nik=MCUserInfo.GetUserNameByUin(uin,MCSessionID);SoundNewMSG.play();DisplayText.append("<div><span class='dT'>["+(new Date()).myFormat("hh:nn:ss")+"]</span>"+" <span class='Op'>"+nik+" ></span> "+_txt+"</div>");i=i+3;if((OperatorFoto.hasClass("hideelement"))||(OperatorFoto.attr("src")!=("../"+MCUserInfo.GetUserFotoByUin(uin)))){OperatorFoto.removeClass("hideelement").attr("src","../"+MCUserInfo.GetUserFotoByUin(uin)).css({height:"70px",width:"70px"});};if((OperatorName.text()=="")||(OperatorName.text()!=nik)){OperatorName.text(nik);};typing=false;break;case"2":if(_txt==""){typing=true;};i=i+2;break;};};if(typing){if(TypingImg.attr("src")=="img/notyping.gif"){OperatorTyping.text(LMSG["9"]);TypingImg.attr("src","img/typing.gif");TypingTimer=setTimeout(function(){OperatorTyping.text(LMSG["8"]);TypingImg.attr("src","img/notyping.gif");typing=false;},3000);};}else{OperatorTyping.text(LMSG["8"]);TypingImg.attr("src","img/notyping.gif");typing=false;clearInterval(TypingTimer);};};};var WEB_CR_IDX=msg.indexOf(CR);if(WEB_CR_IDX==-1)WEB_CR_IDX=msg.length;var request=msg.slice(0,WEB_CR_IDX);var _msg=msg.slice(WEB_CR_IDX+1,msg.length+1);switch(request){case CMD_COMMAND_FAILED:ConnectFailed++;if(ConnectFailed>2){alert(LMSG["47"]);LoginUIN.removeAttr("disabled").val("").blur();LoginPWD.removeAttr("disabled").val("").blur();LoginBTN.toggleClass("disabled");LoginIMG.addClass("hideelement");LoginInProgress=false;LoginUIN.focus();MCSessionID=0;ConnectFailed=0;}else{$.cookie("UIN",null);$.cookie("PWD",null);$.cookie("NAME",null);$.cookie("EMAIL",null);LoginInProgress=false;MCSessionID=0;CookiePresent=false;setTimeout(function(){BeginLogin();},200);};break;case CMD_COMMAND_ACCEPT:LoginForm.addClass("hideelement");LoginUIN.removeAttr("disabled").val("");LoginPWD.removeAttr("disabled").val("");LoginBTN.toggleClass("disabled");LoginIMG.addClass("hideelement");MCSessionID=GetSubstring(_msg,CR);_msg=DelSubstring(_msg,CR);MCAdditional=GetSubstring(_msg,CR);LoginInProgress=false;ConnectFailed=0;if(MCAdditional==CMD_COMMAND_NOT_OPERATOR){InfoWindow.removeClass("hideelement").css("font-size",".7em").TO_WINDOW_CENTER(miniWEBWindow).html("Пользователь, с которым вы хотите связаться, или не существует, или не является оператором WEB поддержки ");}else{var UName="";var UEmail="";var patt=/^WEB[0-9]{8}\w[0-9]{6}$/g;UName=MCUserInfo.GetUserNameByUin(SelfUIN,MCSessionID);var TestResult=patt.test(UName);if((UName!="")&&(TestResult==false)){SelfName=UName;AfterLogin();}else if(($.cookie("NAME")==null)||($.cookie("EMAIL")==null)){SayHello();}else{UName=$.cookie("NAME");UEmail=$.cookie("EMAIL");MCSelfInfo.FillSmallInfo(UName,UEmail,GetUserOS(),GetUserLanguage(),GetUserRefLink(),GetUserBrouser());SelfName=UName;MCConnect.SendDataToServer(CMD_COMMAND_SETSMALLUSERINFO+CR+MCSessionID+CR+MCSelfInfo.GenerateMCUserInfo());AfterLogin();};};break;case CMD_COMMAND_PONG:var isUinOnline=GetSubstring(_msg,CR);_msg=DelSubstring(_msg,CR);if(isUinOnline!=""){MCUserInfo.SetUinOnlineSate(ToUserUIN,IntToBool(isUinOnline));isOnline.text(BooleanStateToString(MCUserInfo.UinIsOnline(ToUserUIN)));};GetMsg(_msg);ScrollDisplayText.scrollTop(99999);break;case CMD_COMMAND_SENDMSG:var WEB_CR_IDX=_msg.indexOf(CR);var iResult=_msg.slice(0,WEB_CR_IDX);switch(iResult){case"0":GetMsg(_msg.slice(WEB_CR_IDX+1,_msg.length+1));sendText=ReplaseURLs(sendText);DisplayText.append("<div><span class='dT'>["+(new Date()).myFormat("hh:nn:ss")+"]</span> <span class='cL'>"+SelfName+" ></span> "+sendText+"</div>");break;case"1":DisplayText.append("<div><span class='dT'>["+(new Date()).myFormat("hh:nn:ss")+"]</span> "+LMSG["48"]+"</div>");break;case"2":DisplayText.append("<div><span class='dT'>["+(new Date()).myFormat("hh:nn:ss")+"]</span> "+LMSG["49"]+"</div>");break;case"3":DisplayText.append("<div><span class='dT'>["+(new Date()).myFormat("hh:nn:ss")+"]</span> "+LMSG["50"]+"</div>");break;case"4":DisplayText.append("<div><span class='dT'>["+(new Date()).myFormat("hh:nn:ss")+"]</span> "+LMSG["51"]+"</div>");break;case"5":DisplayText.append("<div><span class='dT'>["+(new Date()).myFormat("hh:nn:ss")+"]</span> "+LMSG["52"]+"</div>").append("<div><span class='dT'>["+(new Date()).myFormat("hh:nn:ss")+"]</span> <span class='cL'>"+SelfName+" ></span> "+sendText+"</div>");break;case"6":DisplayText.append("<div><span class='dT'>["+(new Date()).myFormat("hh:nn:ss")+"]</span> "+LMSG["53"]+"</div>");break;};ScrollDisplayText.scrollTop(99999);break;case CMD_COMMAND_ACCESSDENIED:break;case CMD_COMMAND_REGISTER_USER:var _arr=_msg.split(/[\r]/);SelfUIN=_arr[0];SelfPWD=_arr[1];TryToLogin(SelfUIN,SelfPWD);break;case CMD_COMMAND_SETSMALLUSERINFO:;break;}};CloseBTN.click(function(){MCConnect.SendDataToServer(CMD_COMMAND_QUIT+CR+MCSessionID+CR+ToUserUIN);window.close();MCConnect=null;clearInterval(TalkTimer);clearInterval(idServerRequests);TextMemo.prop("readonly","readonly");LockUserWindow();InfoWindow.removeClass("hideelement").TO_WINDOW_CENTER(miniWEBWindow);});SendBTN.click(function(){if(OperatorReview.css("top")=="92px"){CloseOpReview();};SoundPressEnter.stop();SoundPressEnter.play();sendText=trim(TextMemo.val().replace("\n"," "));if(sendText!=""){MCConnect.SendDataToServer(CMD_COMMAND_SENDMSG+CR+MCSessionID+CR+ToUserUIN+CR+sendText);};TextMemo.val("").focus();});});